{% extends 'partials/core_template.html' %}
{% load static %}
{% load poll_extras %}
{% block page_title %}
مشاهده جزئیات تیکت
{% endblock page_title %}

{% block main_content %}

    
  <div class="container-fluid py-5">
        <div class="card mb-3 mt-3 shadow-sm">
        <div class="card-header bg-light text-white">
            <h3 class="mb-0">مشاهده تیکت {{ ticket.ticket_no }}#</h3>
        </div>
        <div class="card-body p-3">
            <h5 class="mb-4">موضوع: {{ ticket.subject }}</h5>
           
            {% if not ticket.is_closed %}
                 <button type="button" onclick="document.getElementById('replyForm').scrollIntoView({ behavior: 'smooth' });">
                <i class="fas fa-pencil-alt"></i> پاسخ
            </button>
            <a class="btn btn-danger py-2" href="{%  url 'close_ticket' ticket.id %}">بستن تیکت</a>
                {% else %}
                <div class=" p-2 bg-gradient-warning">
        این تیکت بسته شده است. درصورتی که مشکل شما رفع نشده است، <a href="{% url 'user_support_ticket' %}">تیکت جدید باز کنید</a>.
    </div>
            {% endif %}
            
        </div>
    </div>

    <!-- پیام‌ها -->
    {% for msg in messages %}
    <div class="card mb-2 {% if msg.sender.is_staff %}border-info{% else %}border-secondary{% endif %} shadow-sm">
        <div class="card-header">
               <strong>
            <span class="{% if msg.sender.is_staff %}badge bg-info px-4 py-2 fw-bold{% else %}badge bg-success fw-bold{% endif %}">
                {{ msg.sender_role }}
            </span>
        </strong>
                <span class=" text-muted me-2">{{ msg.created_at|show_jalali_date_time}}</span> 
        </div>
        <div class="card-body">
            <div class="content">{{ msg.message|safe }}</div>
       
            {% if msg.attachments.all %}
                <strong>فایل‌های تیکت:</strong>
            <div class="attachments mt-2">
                <ul>
                    {% for file in msg.attachments.all %}
                        <li><a href="{{ file.file.url }}" target="_blank">{{ file.file.name|slice:"30" }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
  </div>

    
{% if not ticket.is_closed %}
    <div class="container px-4">
	 <h5 class="mt-2">ارسال پاسخ جدید</h5>
     {{ form.non_field_errors }}
        
                <form id="replyForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row text-center">
                           {{ form.message }}
                        {{ form.message.errors }}
                    </div>
                       <div class="col-12 form-group mt-3">
                        <label for="files">آپلود فایل‌ها:</label>
                        <input type="file" name="file" multiple class="form-control">
                    </div>
                    <div class="text-end">
                        <button type="submit" id="success" class="btn btn-primary px-4  mt-2">ارسال پاسخ</button>

                    </div>
                </form>
              </div>
    
{% endif %} 
{#  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>#}
{#<script>#}
{#document.addEventListener("DOMContentLoaded", function() {#}
{#    const form = document.getElementById("replyForm");#}
{##}
{#    if (form) {#}
{#        form.addEventListener("submit", function(e) {#}
{#            e.preventDefault();#}
{##}
{#            // فیلد پیام را بگیر#}
{#            const messageField = form.querySelector('textarea[name="message"]');#}
{#            const messageValue = messageField ? messageField.value.trim() : '';#}
{##}
{#            // اگر پیام خالی بود → خطا#}
{#            if (!messageValue) {#}
{#                Swal.fire({#}
{#                    icon: 'error',#}
{#                    text: 'لطفاً متن پیام را وارد کنید.',#}
{#                    timer: 1800,#}
{#                    showConfirmButton: false#}
{#                });#}
{#                return;#}
{#            }#}
{##}
{#            // اگر پیام معتبر بود → موفقیت و ارسال فرم#}
{#            Swal.fire({#}
{#                icon: 'success',#}
{#                text: 'پاسخ تیکت با موفقیت ارسال شد.',#}
{#                timer: 1500,#}
{#                showConfirmButton: false#}
{#            }).then(() => {#}
{#                form.submit();#}
{#            });#}
{#        });#}
{#    }#}
{##}
{#});#}
</script>


{% endblock main_content %}




