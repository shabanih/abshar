{% load static %}
{% load poll_extras %}
<nav class="sidebar sidebar-offcanvas" id="sidebar">

                      <ul class="nav">
                        <li class="nav-item nav-profile bg-body">
                          <a href="{% url 'middle_manage_house' %}" class="nav-link">
                            <div class="nav-profile-image">
                              <img src="{% static 'admin_panel/icone8/icons8-home (1).gif' %}" width="20" alt="profile">
                            </div>
                              <br>
                           <div class="nav-profile-text ms-auto mt-3">
                             <h6> {{ middle_house.name|default:"ساختمان من" }}</h6>
                                  <small class="text-muted text-center p-2"> ویرایش</small>
                                </div>

                          </a>
                        </li>


            {% if middle_house.id %}
<li class="nav-item text-center mb-1">
<div class="row py-2">
  <div class="col-12 text-center">
    <div class="card shadow-lg card-small">
      <div class="card-body py-1 p-3">
        <div class="d-flex align-items-center justify-content-center">

          <div class="subscription-circle-wrapper" style="width:80px; height:80px; position: relative;">

            <svg width="80" height="80" viewBox="0 0 130 130">
              <!-- بک گراند دایره -->
              <circle cx="65" cy="65" r="55"
                      stroke="#e6e6e6"
                      stroke-width="10"
                      fill="none"/>

              <!-- نوار پیشرفت -->
              {% if total_days > 0 %}
                  <circle cx="65" cy="65" r="55"
                    stroke="{% if sub_status == 'trial' %}#28a745{% elif sub_status == 'paid' %}#007bff{% else %}#ccc{% endif %}"
                    stroke-width="10"
                    fill="none"
                    stroke-dasharray="345"
                    stroke-dashoffset="{{ progress_dashoffset }}"
                    transform="rotate(-90 65 65)"
                    stroke-linecap="round"/>

              {% endif %}
            </svg>

            <!-- متن وسط دایره -->
            <div class="subscription-circle-center"
                 style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center;">
              <div class="subscription-remaining" style="font-weight:bold; font-size:16px;">
                {{ remaining_days }}
              </div>
              <div class="subscription-divider" style="font-size:10px;"></div>
              <div class="subscription-total" style="font-size:12px;">
                {{ total_days }}
              </div>
            </div>

          </div>

        </div>

        <!-- وضعیت اشتراک و دکمه خرید -->
        <div class="mt-1">
          {% if sub_status == "trial" %}
            <div class="subscription-status subscription-trial">اشتراک رایگان فعال</div>
          {% elif sub_status == "paid" %}
            <div class="subscription-status subscription-paid">اشتراک {{ plan }} فعال</div>
          {% elif sub_status == "inactive" %}
            <a href="{% url 'buy_subscription' %}" class="btn btn-gradient-secondary p-1">
              <img src="{% static 'admin_panel/icone8/icons8-plus.gif' %}" class="mx-2" width="20" alt="">
              خرید اشتراک
            </a>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</div>

{#<div class="row py-2">#}
{#  <div class="col-12 text-center">#}
{#    <div class="card shadow-lg card-small">#}
{##}
{#      <div class="card-body py-1 p-3">#}
{# <div class="d-flex align-items-center justify-content-center">#}
{##}
{#        <div class="subscription-circle-wrapper" style="width:80px; height:80px;">#}
{##}
{#    <svg width="80" height="80" viewBox="0 0 130 130">#}
{#      <!-- بک گراند -->#}
{#      <circle cx="65" cy="65" r="55"#}
{#              stroke="#000080"#}
{#              stroke-width="10"#}
{#              fill="none"/>#}
{##}
{#      <!-- نوار پیشرفت -->#}
{#      <circle cx="65" cy="65" r="55"#}
{#              stroke="{% if sub_status == 'trial' %}#ffffff{% elif sub_status == 'paid' %}#ffffff{% elif sub_status == 'inactive' %}#ffffff{% else %}#ccc{% endif %}"#}
{#              stroke-width="10"#}
{#              fill="none"#}
{#              stroke-dasharray="345"#}
{#              stroke-dashoffset="{% widthratio remaining_days total_days 345 %}"#}
{#              transform="rotate(-90 65 65)"#}
{#              stroke-linecap="round"/>#}
{#    </svg>#}
{##}
{#    <!-- متن وسط دایره -->#}
{#    <div class="subscription-circle-center">#}
{#      <div class="subscription-remaining">{{ remaining_days }} </div>#}
{#      <div class="subscription-divider"></div>#}
{#      <div class="subscription-total">{{ total_days }}  </div>#}
{#    </div>#}
{##}
{#</div>#}
{##}
{#        </div>#}
{#    <div class="mt-1">#}
{#            {% if sub_status == "trial" %}#}
{#              <div class="subscription-status subscription-trial">اشتراک رایگان فعال</div>#}
{#            {% elif sub_status == "paid" %}#}
{#              <div class="subscription-status subscription-paid">اشتراک {{ plan }} فعال</div>#}
{#                {% elif sub_status == "inactive" %}#}
{#              <div class="subscription-status subscription-inactive">اشتراک منقضی شده</div>#}
{#                    <a href="{% url 'buy_subscription' %}" class="btn btn-gradient-secondary p-1">#}
{#                      <img src="{% static 'admin_panel/icone8/icons8-plus.gif' %}" class="mx-2" width="20" alt="">#}
{#                      خرید اشتراک#}
{#                    </a>#}
{#                {% else %}#}
{#            <!-- دکمه خرید اشتراک -->#}
{#                    <a href="{% url 'buy_subscription' %}" class="btn btn-gradient-secondary p-1">#}
{#                      <img src="{% static 'admin_panel/icone8/icons8-plus.gif' %}" class="mx-2" width="20" alt="">#}
{#                      خرید اشتراک#}
{#                    </a>#}
{#            {% endif %}#}
{#          </div>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
    <div class="row text-center">
    <div class="col-12">
                {% if user.is_resident and user.is_unit %}
  <a href="{% url 'switch_to_resident' %}"
     class="btn btn-gradient-primary px-1 py-2 w-100">
      ورود به پنل ساکنین
  </a>
{% endif %}
    </div>
</div>





</li>

            <li class="nav-item border-top">
               {% url 'middle_admin_dashboard' as address_url %}
                <a class="nav-link {% if request.path == address_url %}active{% endif %}" href="{{ address_url }}">
                <i class="menu-title">داشبورد مدیر</i>
                <i class="mdi mdi-cellphone-link menu-icon"></i>
              </a>
            </li>


                {% url 'middle_send_announcement' as url_middle_send %}
                {% url 'middle_announcement' as url_middle_list %}

                <li class="nav-item mt-0">
                  <a class="nav-link" data-bs-toggle="collapse"
                     href="#general66"
                     aria-expanded="true"
                     aria-controls="general66">
                    <i class="menu-title"> مدیریت اطلاعیه ها </i>
                    <i class="menu-arrow"></i>
                    <i class="mdi mdi-bell-alert menu-icon"></i>
                  </a>

                  <div class="collapse {% if request.path == url_middle_send or request.path == url_middle_list %}show{% endif %}" id="general66">
                    <ul class="nav flex-column sub-menu">

                      <li class="nav-item mt-0">
                        <a class="nav-link {% if request.path == url_middle_send %}active{% endif %}"
                           href="{{ url_middle_send }}">
                           ارسال اطلاعیه
                        </a>
                      </li>

                      <li class="nav-item mt-0">
                        <a class="nav-link {% if request.path == url_middle_list %}active{% endif %}"
                           href="{{ url_middle_list }}">
                           اطلاعیه های من
                        </a>
                      </li>

                    </ul>
                  </div>
                </li>

                       {% url 'message_to_user' as url_message_to_user %}
            {% url 'middle_message_management' as url_middle_message_list %}
            {% url 'middle_message_management_from_admin' as url_middle_message_from_admin_list %}

            <li class="nav-item border-top mt-0">
              <a class="nav-link" data-bs-toggle="collapse"
                 href="#general145"
                 aria-expanded="true"
                 aria-controls="general145">
                <i class="menu-title"> مدیریت پیام ها </i>
                <i class="menu-arrow"></i>
                <i class="fas fa-bullhorn fa-flip-horizontal menu-icon"></i>
              </a>

              <div class="collapse {% if request.path == url_message_to_user or request.path == url_middle_message_list or request.path == url_middle_message_from_admin_list %}show{% endif %}" id="general145">
                <ul class="nav flex-column sub-menu">

                  <li class="nav-item mt-0">
                    <a class="nav-link {% if request.path == url_message_to_user %}active{% endif %}"
                       href="{{ url_message_to_user }}">
                       ثبت پیام
                    </a>
                  </li>

                  <li class="nav-item mt-0">
                    <a class="nav-link {% if request.path == url_middle_message_list %}active{% endif %}"
                       href="{{ url_middle_message_list }}">
                       پیام های ارسالی
                    </a>
                  </li>
                    <li class="nav-item mt-0">
                    <a class="nav-link {% if request.path == url_middle_message_from_admin_list %}active{% endif %}"
                       href="{{ url_middle_message_from_admin_list }}">
                       پیام های ادمین
                    </a>
                  </li>

                </ul>
              </div>
            </li>

                 <li class="nav-item border-top mt-0">
                 {% url 'middle_manage_bank' as address_url %}
                <a class="nav-link {% if request.path == address_url %}active{% endif %}" href="{{ address_url }}">
                <i class="menu-title"> مدیریت حساب بانکی</i>
                <i class="fas fa-bank menu-icon menu-icon"></i>
              </a>
            </li>
          
{#           <li class="nav-item  mt-0">#}
{#                 {% url 'middle_manage_unit' as address_url %}#}
{#                <a class="nav-link {% if request.path == address_url %}active{% endif %}" href="{{ address_url }}">#}
{#                <i class="menu-title"> مدیریت واحدها</i>#}
{#                <i class="mdi mdi-city menu-icon menu-icon"></i>#}
{#              </a>#}
{#            </li>#}
                <li class="nav-item mt-0">
    <a class="nav-link
    {% if request.resolver_match.url_name == 'middle_manage_unit' or request.resolver_match.url_name == 'middle_unit_register'%}
       active
    {% endif %}"
    href="{% url 'middle_manage_unit' %}">

        <i class="menu-title">مدیریت واحدها</i>
        <i class="mdi mdi-city menu-icon"></i>
    </a>
</li>

                 <li class="nav-item  mt-0">
                 {% url 'middleAdmin_fund_turn_over' as address_url %}
                <a class="nav-link {% if request.path == address_url %}active{% endif %}" href="{{ address_url }}">
                <i class="menu-title"> امور مالی</i>
                <i class="mdi mdi-cash-multiple menu-icon menu-icon"></i>
              </a>
            </li>

                {% with url=request.resolver_match.url_name %}

{% is_charge_section url as charge_open %}

<li class="nav-item mt-0 border-top">

  <a class="nav-link"
     data-bs-toggle="collapse"
     href="#general3"
     aria-expanded="{% if charge_open %}true{% else %}false{% endif %}">

    <i class="menu-title">مدیریت شارژ</i>
    <i class="menu-arrow"></i>
    <i class="mdi mdi-clipboard-text menu-icon"></i>
  </a>

  <div class="collapse {% if charge_open %}show{% endif %}" id="general3">
    <ul class="nav flex-column sub-menu">

      <li class="nav-item">
      <a class="nav-link {% if 'middle_add' in url %}active{% endif %}"
   href="{% url 'middle_add_charge' %}">
   افزودن شارژ
</a>
      </li>

      <li class="nav-item">
       <a class="nav-link {% if 'middle_main_charges' in url %}active{% endif %}"
   href="{% url 'middle_main_charges' %}">
   شارژ های من
</a>
      </li>


    </ul>
  </div>

</li>

{% endwith %}


{#   <li class="nav-item border-top mt-0">#}
{#  <a class="nav-link" data-bs-toggle="collapse" href="#general40"#}
{#     aria-expanded="{% if request.resolver_match.url_name in 'middle_add_charge middle_add_expense    ' %}true{% else %}false{% endif %}"#}
{#     aria-controls="general40">#}
{#    <i class="menu-title">مدیریت شارژ</i>#}
{#    <i class="menu-arrow"></i>#}
{#        <i class="mdi mdi-square-inc-cash menu-icon"></i>#}
{#  </a>#}
{#  <div class="collapse {% if request.resolver_match.url_name in 'middle_add_charge middle_main_charges' %}show{% endif %}" id="general40">#}
{#    <ul class="nav flex-column sub-menu">#}
{#      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'middle_add_charge' %}active{% endif %}" href="{% url 'middle_add_charge' %}">افزودن شارژ</a></li>#}
{#      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'middle_main_charges' %}active{% endif %}" href="{% url 'middle_main_charges' %}"> شارژ های من</a></li>#}
{##}
{#    </ul>#}
{#  </div>#}
{#</li>#}
             <li class="nav-item border-top mt-0">
  <a class="nav-link" data-bs-toggle="collapse" href="#general23"
     aria-expanded="{% if request.resolver_match.url_name in 'middle_add_income middle_add_expense middle_add_receive middle_add_pay middle_add_property middle_add_maintenance' %}true{% else %}false{% endif %}"
     aria-controls="general23">
    <i class="menu-title">عملیات</i>
    <i class="menu-arrow"></i>
    <i class="mdi mdi-desktop-mac menu-icon"></i>
  </a>
  <div class="collapse {% if request.resolver_match.url_name in 'middle_add_income middle_add_expense middle_add_receive middle_add_pay middle_add_property middle_add_maintenance' %}show{% endif %}" id="general23">
    <ul class="nav flex-column sub-menu">
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'middle_add_income' %}active{% endif %}" href="{% url 'middle_add_income' %}">ثبت درآمد</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'middle_add_expense' %}active{% endif %}" href="{% url 'middle_add_expense' %}">ثبت هزینه</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'middle_add_receive' %}active{% endif %}" href="{% url 'middle_add_receive' %}">ثبت اسناد دریافتنی</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'middle_add_pay' %}active{% endif %}" href="{% url 'middle_add_pay' %}">ثبت اسناد پرداختنی</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'middle_add_property' %}active{% endif %}" href="{% url 'middle_add_property' %}">ثبت اموال ساختمان</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'middle_add_maintenance' %}active{% endif %}" href="{% url 'middle_add_maintenance' %}">ثبت تعمیر و نگهداری</a></li>
    </ul>
  </div>
</li>

              <li class="nav-item mt-0">
  <a class="nav-link" data-bs-toggle="collapse" href="#general2"
     aria-expanded="{% if request.resolver_match.url_name in 'fund_turn_over unit_reports middle_bank_list debtor_units_report unit_history_report expense_history_report income_history_report property_history_report maintenance_history_report pay_receive_report charge_notify_report_list house_balance_view' %}true{% else %}false{% endif %}"
     aria-controls="general2">
    <i class="menu-title">گزارشات</i>
    <i class="menu-arrow"></i>
    <i class="mdi mdi-clipboard-text menu-icon"></i>
  </a>
  <div class="collapse {% if request.resolver_match.url_name in 'fund_turn_over unit_reports middle_bank_list debtor_units_report unit_history_report expense_history_report income_history_report property_history_report maintenance_history_report pay_receive_report charge_notify_report_list house_balance_view ' %}show{% endif %}" id="general2">
    <ul class="nav flex-column sub-menu">
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'fund_turn_over' %}active{% endif %}" href="{% url 'fund_turn_over' %}">گردش صندوق</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'unit_reports' %}active{% endif %}" href="{% url 'unit_reports' %}">گردش مالی اشخاص</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'middle_bank_list' %}active{% endif %}" href="{% url 'middle_bank_list' %}"> بانک ها</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'charge_notify_report_list' %}active{% endif %}" href="{% url 'charge_notify_report_list' %}">شارژ های اعلامی</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'debtor_units_report' %}active{% endif %}" href="{% url 'debtor_units_report' %}">واحدهای بدهکار</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'unit_history_report' %}active{% endif %}" href="{% url 'unit_history_report' %}">سوابق سکونت واحدها</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'expense_history_report' %}active{% endif %}" href="{% url 'expense_history_report' %}">هزینه‌ها</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'income_history_report' %}active{% endif %}" href="{% url 'income_history_report' %}">درآمدها</a></li>
       <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'pay_receive_report' %}active{% endif %}" href="{% url 'pay_receive_report' %}">دریافت و پرداخت</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'property_history_report' %}active{% endif %}" href="{% url 'property_history_report' %}">اموال ساختمان</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'maintenance_history_report' %}active{% endif %}" href="{% url 'maintenance_history_report' %}">تعمیر و نگهداری</a></li>
      <li class="nav-item mt-0"><a class="nav-link {% if request.resolver_match.url_name == 'house_balance_view' %}active{% endif %}" href="{% url 'house_balance_view' %}">بیلان ساختمان</a></li>

    </ul>
  </div>
</li>


                            <li class="nav-item border-top mt-0">
                            {% url 'middle_tickets' as address_url %}
                           <a class="nav-link {% if request.path == address_url %}active{% endif %}" href="{{ address_url }}">
                            <i class="menu-title">مدیریت تیکت ها</i>

                            <span id="ticket-counter-main" class="badge bg-danger counter-badge">0</span>
                               <input type="hidden" id="ticket-id" value="{{ ticket.id }}">

                               <i class="mdi mdi-headset menu-icon"></i>
                          </a>
                        </li>

            {% url 'add_sms_credit' as url_middle_credit_sms %}
            {% url 'middle_register_sms' as url_middle_register_sms %}
            {% url 'middle_sms_management' as url_middle_sms_list %}

            <li class="nav-item border-top mt-0">
              <a class="nav-link" data-bs-toggle="collapse"
                 href="#general77"
                 aria-expanded="true"
                 aria-controls="general77">
                <i class="menu-title"> مدیریت پیامک ها </i>
                <i class="menu-arrow"></i>
                <i class="fas fa-comment-dots menu-icon"></i>
              </a>

              <div class="collapse {% if request.path == url_middle_register_sms or request.path == url_middle_sms_list or request.path == url_middle_credit_sms  %}show{% endif %}" id="general77">
                <ul class="nav flex-column sub-menu">

                    <li class="nav-item mt-0">
                    <a class="nav-link {% if request.path == url_middle_credit_sms %}active{% endif %}"
                       href="{{ url_middle_credit_sms }}">
                       شارژ حساب پیامک
                    </a>
                  </li>

                  <li class="nav-item mt-0">
                    <a class="nav-link {% if request.path == url_middle_register_sms %}active{% endif %}"
                       href="{{ url_middle_register_sms }}">
                       ثبت و ارسال پیامک
                    </a>
                  </li>

                  <li class="nav-item mt-0">
                    <a class="nav-link {% if request.path == url_middle_sms_list %}active{% endif %}"
                       href="{{ url_middle_sms_list }}">
                       پیامک های من
                    </a>
                  </li>

                </ul>
              </div>
            </li>


             {% url 'middleAdmin_support_ticket' as url_support_ticket %}
            {% url 'middleAdmin_tickets' as url_support_list %}

            <li class="nav-item border-top mt-0">

                <a class="nav-link
                    {% if request.path == url_support_ticket or request.path == url_support_list %}active{% endif %}"
                   data-bs-toggle="collapse"
                   href="#general4">

                    <i class="menu-title">پشتیبانی</i>

                    <span id="ticket-counter-middle-admin" class="badge bg-danger counter-badge-middle">0</span>

                    <i class="menu-arrow"></i>
                    <i class="mdi mdi-headphones-box menu-icon"></i>
                </a>

                <div class="collapse
                    {% if request.path == url_support_ticket or request.path == url_support_list %}show{% endif %}"
                     id="general4">

                    <ul class="nav flex-column sub-menu">

                        <li class="nav-item mt-0">
                            <a class="nav-link {% if request.path == url_support_ticket %}active{% endif %}"
                               href="{{ url_support_ticket }}">
                                 ارسال تیکت به ادمین
                            </a>
                        </li>

                        <li class="nav-item mt-0">
                            <a class="nav-link {% if request.path == url_support_list %}active{% endif %}"
                               href="{{ url_support_list }}">
                                تیکت‌های من
                            </a>
                        </li>

                    </ul>
                </div>

            </li>

         {% endif %}
             

          </ul>

</nav>
<style>
    .counter-badge {
    position: relative;
    top: -8px;
    right: -12px;
    font-size: 12px;
    padding: 3px 6px;
    border-radius: 50%;
}

.counter-badge-middle{
    position: relative;
    top: -8px;
    right: -29px;
    font-size: 12px;
    padding: 3px 6px;
    border-radius: 50%;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const userSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/tickets/"
);

userSocket.onmessage = function(e) {
    console.log("WS message received:", e.data);
    const data = JSON.parse(e.data);
    const el = document.getElementById("ticket-counter-main");
    el.textContent = data.count;
    el.style.display = data.count > 0 ? "inline-block" : "none";
};

userSocket.onopen = function(e) {
    console.log("WebSocket connected!");
};
userSocket.onclose = function(e) {
    console.log("WebSocket closed!");
};

</script>

<script>
    const middleSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/tickets/admin/"
);

middleSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const el = document.getElementById("ticket-counter-middle-admin"); // یا ticket-counter-admin
    el.textContent = data.count;
    el.style.display = data.count > 0 ? "inline-block" : "none";
};

middleSocket.onopen = function(e) {
    console.log("WebSocket connected!");
};
middleSocket.onclose = function(e) {
    console.log("WebSocket closed!");
};

</script>


