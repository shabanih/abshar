{% load static %}
<nav class="sidebar sidebar-offcanvas" id="sidebar">

          <ul class="nav">
            <li class="nav-item nav-profile bg-body">
              <a href="{% url 'middle_manage_house' %}" class="nav-link">
                <div class="nav-profile-image">
                  <img src="{% static 'admin_panel/icone8/icons8-home (1).gif' %}" width="20" alt="profile">
                  <span class="login-status online"></span>
                  <!--change to offline or busy as needed-->
                </div>
                  <br>
               <div class="nav-profile-text ms-2 mt-3 ">
      {% if house and house.name %}
        <h6 class="mb-2  fw-bold"> {{ house.name }}</h6>
      {% else %}
        <h6 class="mb-1">ساختمان من</h6>
      {% endif %}
      <small class="text-muted p-2">افزودن / ویرایش</small>
    </div>
{#                <i class="mdi mdi-home text-secondary nav-profile-badge" style="font-size: 2.125rem;"></i>#}

              </a>
            </li>

            <li class="nav-item border-top">
               {% url 'middle_admin_dashboard' as address_url %}
                <a class="nav-link {% if request.path == address_url %}active{% endif %}" href="{{ address_url }}">
                <i class="menu-title">داشبورد</i>
                <i class="mdi mdi-cellphone-link menu-icon"></i>
              </a>
            </li>

                <li class="nav-item mt-0">
                 {% url 'middle_announcement' as address_url %}
                <a class="nav-link {% if request.path == address_url %}active{% endif %}" href="{{ address_url }}">
                <i class="menu-title"> مدیریت اطلاعیه ها</i>
                <i class="mdi mdi-bell-ring-outline menu-icon"></i>
              </a>
            </li>
                 <li class="nav-item border-top mt-0">
                 {% url 'middle_manage_bank' as address_url %}
                <a class="nav-link {% if request.path == address_url %}active{% endif %}" href="{{ address_url }}">
                <i class="menu-title"> مدیریت حساب بانکی</i>
                <i class="fas fa-bank menu-icon menu-icon"></i>
              </a>
            </li>
          
           <li class="nav-item  mt-0">
                 {% url 'middle_manage_unit' as address_url %}
                <a class="nav-link {% if request.path == address_url %}active{% endif %}" href="{{ address_url }}">
                <i class="menu-title"> مدیریت واحدها</i>
                <i class="mdi mdi-city menu-icon menu-icon"></i>
              </a>
            </li>

          
               <li class="nav-item border-top mt-0">
                 {% url 'middle_add_charge' as address_url %}
                <a class="nav-link {% if request.path == address_url %}active{% endif %}" href="{{ address_url }}">
                <i class="menu-title"> مدیریت شارژ</i>
                <i class="mdi mdi-square-inc-cash menu-icon"></i>
              </a>
            </li>

             <li class="nav-item border-top mt-0">
              <a class="nav-link" data-bs-toggle="collapse" href="#general23" aria-expanded="true"
                 aria-controls="general23">
                <i class="menu-title"> عملیات</i>
                <i class="menu-arrow"></i>
                <i class="mdi mdi-desktop-mac menu-icon"></i>
              </a>
              <div class="collapse" id="general23">
                <ul class="nav flex-column sub-menu">
                    <li class="nav-item mt-0">
                    <a class="nav-link" href="{% url 'middle_add_income' %}"> ثبت درآمد  </a></li>
                    <li class="nav-item mt-0">
                    <a class="nav-link" href="{% url 'middle_add_expense' %}"> ثبت هزینه  </a></li>
                  <li class="nav-item mt-0">
                    <a class="nav-link" href="{% url 'middle_add_receive' %}">مدیریت اسناد دریافتنی </a></li>
                    <li class="nav-item mt-0">
                    <a class="nav-link" href="{% url 'middle_add_pay' %}"> مدیریت اسناد پرداختنی </a></li>
                     <li class="nav-item mt-0">
                    <a class="nav-link" href="{% url 'middle_add_property' %}"> ثبت اموال ساختمان </a></li>
                      <li class="nav-item mt-0">
                    <a class="nav-link" href="{% url 'middle_add_maintenance' %}"> ثبت تعمیر و نگهداری </a></li>

                </ul>
              </div>
          <li class="nav-item mt-0">
              <a class="nav-link" data-bs-toggle="collapse" href="#general2" aria-expanded="true"
                 aria-controls="general2">
                <i class="menu-title"> گزارشات </i>
                <i class="menu-arrow"></i>
                <i class="mdi mdi-clipboard-text menu-icon"></i>
              </a>
              <div class="collapse" id="general2">
                <ul class="nav flex-column sub-menu">
                    <li class="nav-item mt-0">
                    <a class="nav-link" href="{% url 'fund_turn_over' %}"> گردش صندوق </a></li>
                    <li class="nav-item mt-0">
                    <a class="nav-link" href="{% url 'unit_reports' %}"> گردش مالی اشخاص </a></li>
                  <li class="nav-item mt-0">
                    <a class="nav-link" href="#"> واحدهای بدهکار/بستانکار </a></li>
                    <li class="nav-item mt-0">
                    <a class="nav-link" href="#">  قبوض </a></li>
                    <li class="nav-item mt-0">
                    <a class="nav-link" href="#"> هزینه ها </a></li>
                    <li class="nav-item mt-0">
                    <a class="nav-link" href="#"> درآمدها </a></li>
                     <li class="nav-item mt-0">
                    <a class="nav-link" href="#"> اموال ساختمان </a></li>
                     <li class="nav-item mt-0">
                    <a class="nav-link" href="#"> تعمیر و نکهداری </a></li>
                    <li class="nav-item mt-0">
                    <a class="nav-link" href="#"> بیلان ساختمان </a></li>
                </ul>
              </div>
            </li>
                   <li class="nav-item border-top mt-0">
                            {% url 'middle_tickets' as address_url %}
                           <a class="nav-link {% if request.path == address_url %}active{% endif %}" href="{{ address_url }}">
                            <i class="menu-title">مدیریت تیکت ها</i>

                            <span id="ticket-counter-main" class="badge bg-danger counter-badge">0</span>
                               <input type="hidden" id="ticket-id" value="{{ ticket.id }}">

                               <i class="mdi mdi-headset menu-icon"></i>
                          </a>
                        </li>

             <li class="nav-item border-top mt-0">
                            <a class="nav-link">
                            <i class="menu-title"> مدیریت پیامک ها</i>
                            <i class="fas fa-comment-dots menu-icon"></i>
                          </a>
                        </li>




                 <li class="nav-item border-top mt-0">

                   <a class="nav-link d-flex align-items-center position-relative
                       {% if request.resolver_match.url_name == 'middle_support_ticket' or request.resolver_match.url_name == 'middle_tickets' %}active{% endif %}"
               data-bs-toggle="collapse"
               href="#general4">


                <span class="ms-2">پشتیبانی</span>
                <span id="ticket-counter-main" class="badge bg-danger counter-badge">0</span>
{#                       <span id="ticket-counter-main" class="badge bg-danger counter-badge"> </span>#}



                <i class="menu-arrow"></i>
                <i class="mdi mdi-headphones menu-icon"></i>
            </a>
            <div class="collapse
                {% if request.resolver_match.url_name == 'middle_support_ticket' or request.resolver_match.url_name == 'middle_tickets' %}show{% endif %}"
                id="general4">

                <ul class="nav flex-column sub-menu">

                    <li class="nav-item mt-0">
                        <a class="nav-link {% if request.resolver_match.url_name == 'middle_support_ticket' %}active{% endif %}"
                           href="{% url 'user_support_ticket' %}">ارسال تیکت</a>
                    </li>

                    <li class="nav-item mt-0">
                        <a class="nav-link {% if request.resolver_match.url_name == 'middle_tickets' %}active{% endif %}"
                           href="{% url 'middle_tickets' %}">تیکت‌های من
{#                           <span id="ticket-counter-sub" class="badge bg-danger counter-badge_second">0</span>#}

                        </a>
                    </li>

                </ul>
            </div>
        </li>
          
             

          </ul>

</nav>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const userSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/tickets/"
);

userSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const el = document.getElementById("ticket-counter-main"); // یا ticket-counter-admin
    el.textContent = data.count;
    el.style.display = data.count > 0 ? "inline-block" : "none";
};

userSocket.onopen = function(e) {
    console.log("WebSocket connected!");
};
userSocket.onclose = function(e) {
    console.log("WebSocket closed!");
};

</script>
{#<script>#}
{#  const adminCounter = document.getElementById("ticket-counter-admin");#}
{##}
{#    function updateAdminTicketCounter() {#}
{#        fetch("/notifications/ticket-counter/admin/")#}
{#            .then(res => res.json())#}
{#            .then(data => {#}
{#                adminCounter.textContent = data.count;#}
{#                adminCounter.style.display = data.count > 0 ? "inline-block" : "none";#}
{#            });#}
{#    }#}
{##}
{#    updateAdminTicketCounter();#}
{#    setInterval(updateAdminTicketCounter, 3000);#}
{##}
{#    document.querySelectorAll(".ticket-link-admin").forEach(link => {#}
{#        link.addEventListener("click", function(){#}
{#            const ticketId = this.dataset.ticketId;#}
{#            fetch(`/notifications/reset-ticket-counter-admin/${ticketId}/`)#}
{#                .then(res => res.json())#}
{#                .then(data => {#}
{#                    if(data.success){#}
{#                        adminCounter.textContent = data.remaining;#}
{#                        adminCounter.style.display = data.remaining > 0 ? "inline-block" : "none";#}
{#                    }#}
{#                });#}
{#        });#}
{#    });#}
{##}
{#</script>#}



